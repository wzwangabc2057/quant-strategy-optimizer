# 多因子量化策略 - 生产级升级路线图

## 一、风险排查清单

### 1.1 已识别的数据泄漏风险

| 风险点 | 严重程度 | 当前状态 | 修复方案 |
|--------|---------|---------|---------|
| 财务数据时点泄漏 | **高** | 使用报告期数据，未考虑披露延迟 | 引入asof_date机制 |
| 幸存者偏差 | **高** | 持仓文件为2025-12-31时点，可能已剔除退市股 | 历史时点股票池重构 |
| 未来函数 | **中** | 动量计算可能使用当日收盘价 | 信号日<交易日断言 |
| 价格数据对齐 | **中** | 复权价格可能存在前视 | 使用点数复权或历史复权快照 |

### 1.2 成本模型缺陷

| 缺陷 | 影响 | 修复方案 |
|------|------|---------|
| 固定佣金率 | 低估实际成本 | 分层佣金+最低5元 |
| 忽略滑点 | 高估收益 | 按成交量分层滑点模型 |
| 忽略冲击成本 | 高估大资金收益 | 按成交额/流动性估算冲击 |
| 涨跌停无法成交 | 高估收益 | 增加涨跌停过滤 |

### 1.3 验证框架缺陷

| 缺陷 | 影响 | 修复方案 |
|------|------|---------|
| 单路径回测 | 过拟合风险 | Walk-forward验证 |
| 无扰动测试 | 参数敏感性未知 | 因子权重/股票池扰动 |
| 无压力测试 | 极端情况表现未知 | 成本加倍/滑点加大测试 |

---

## 二、文件改动清单

### 2.1 新增文件

```
quant-strategy-optimizer/
├── backtest/
│   ├── data_alignment.py     # asof对齐、反泄漏join
│   ├── cost_model.py         # 成本/滑点/冲击成本
│   ├── validation.py         # walk-forward/扰动测试
│   └── survivorship.py       # 幸存者偏差处理
├── strategy/
│   └── governance.py         # 组合约束/风险预算
├── results/
│   └── run_logger.py         # run_id/快照/审计
├── config/
│   ├── base.yaml             # 基础配置
│   ├── r4_stable.yaml        # R4配置
│   └── r5_aggressive.yaml    # R5配置
├── docs/
│   └── roadmap_prod_ready.md # 本文档
└── scripts/
    ├── run_validation.py     # 验证脚本
    └── run_stress_test.py    # 压力测试脚本
```

### 2.2 修改文件

| 文件 | 修改内容 |
|------|---------|
| `backtest/engine.py` | 集成asof对齐、成本模型、治理约束 |
| `strategies/v4_smart.py` | 使用新验证框架 |
| `run_all.py` | 增加验证/压力测试/对比输出 |
| `config.py` | 增加生产级配置项 |

---

## 三、验收门槛表 (KPI Gate)

### 3.1 基准门槛（必须达标）

| 指标 | R4稳健型 | R5进取型 | 说明 |
|------|---------|---------|------|
| 年化收益 | ≥18% | ≥20% | 相对基准+5%以上 |
| 最大回撤 | ≤20% | ≤25% | 风控底线 |
| 夏普比率 | ≥1.0 | ≥1.0 | 风险调整后收益 |
| 换手率 | ≤300%/年 | ≤400%/年 | 交易成本控制 |
| 胜率 | ≥55% | ≥50% | 盈利月份占比 |

### 3.2 压力测试门槛（成本×2）

| 指标 | R4稳健型 | R5进取型 |
|------|---------|---------|
| 年化收益降幅 | ≤30% | ≤35% |
| 夏普比率 | ≥0.7 | ≥0.7 |

### 3.3 鲁棒性门槛（扰动测试）

| 测试项 | 要求 |
|--------|------|
| 因子权重±20% | 年化收益波动≤15% |
| 股票池剔除10% | 年化收益波动≤10% |
| 调仓频率减半 | 年化收益波动≤20% |

### 3.4 自动回退规则

```python
def check_gate(results, gate_config):
    """验收门槛检查"""
    failures = []

    # 基础门槛
    if results['annual_return'] < gate_config['min_return']:
        failures.append(f"年化收益不达标: {results['annual_return']:.2%}")

    if results['max_drawdown'] > gate_config['max_drawdown']:
        failures.append(f"回撤超标: {results['max_drawdown']:.2%}")

    # 压力测试
    if results['stress_return_drop'] > 0.30:
        failures.append(f"压力测试收益降幅过大: {results['stress_return_drop']:.2%}")

    if failures:
        print("⚠️ 验收失败，建议回退到v3")
        for f in failures:
            print(f"  - {f}")
        return False, 'v3'

    print("✅ 验收通过")
    return True, 'v4'
```

---

## 四、实施优先级

### Phase 1: 数据治理（必须优先）

1. 实现 `data_alignment.py` - asof对齐
2. 实现 `survivorship.py` - 幸存者偏差处理
3. 修改财务数据查询，增加披露日期字段

### Phase 2: 成本模型

1. 实现 `cost_model.py` - 分层成本
2. 增加涨跌停过滤
3. 实现冲击成本估算

### Phase 3: 验证框架

1. 实现 `validation.py` - walk-forward
2. 实现扰动测试
3. 实现压力测试

### Phase 4: 组合治理

1. 实现 `governance.py` - 约束条件
2. 实现风险预算
3. 集成到回测引擎

### Phase 5: 审计日志

1. 实现 `run_logger.py`
2. 增加配置快照
3. 增加结果归档

---

## 五、默认假设

在缺少确认的情况下，按以下假设推进：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 财务数据披露延迟 | 45天 | 季报披露截止日 |
| 滑点基础值 | 0.1% | 正常流动性股票 |
| 冲击成本系数 | 0.05% | 每100万成交额 |
| 单票权重上限 | 8% | 监管要求 |
| 行业权重上限 | 25% | 分散化要求 |
| 最小流动性要求 | 1000万/日 | 成交额 |

---

## 六、检查清单（需确认）

- [ ] ClickHouse中是否有 `report_date`（报告期）和 `announce_date`（披露日）字段？
- [ ] 是否有退市股票的历史数据？
- [ ] 是否有行业分类数据？
- [ ] 实际佣金费率是多少？
- [ ] 预期资金规模是多少？（影响冲击成本）
- [ ] 是否有涨跌停标记数据？
